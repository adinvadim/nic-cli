#!/usr/bin/env python3
"""
NIC.RU DNS API CLI tool for OpenClaw.
"""

import argparse
import json
import os
import sys
import xml.etree.ElementTree as ET
from datetime import datetime, timedelta
from pathlib import Path
from urllib.parse import urlencode

try:
    import requests
except ImportError:
    print("Error: requests library required. Install: pip install requests", file=sys.stderr)
    sys.exit(1)

# API endpoints
OAUTH_URL = "https://api.nic.ru/oauth/token"
API_BASE = "https://api.nic.ru/dns-master"

# Constants
KNOWN_SERVICES = ["DP2506122468", "DP2506128828", "DP2510072361"]
DEFAULT_SERVICE = "DP2510072361"

# Paths
SECRETS_DIR = Path.home() / ".openclaw" / "workspace" / ".secrets"
TOKEN_FILE = SECRETS_DIR / "nic-ru-token.json"
CREDENTIALS_FILE = SECRETS_DIR / "nic-ru-credentials"


def load_credentials():
    creds = {}
    env_vars = ["NIC_APP_LOGIN", "NIC_APP_PASSWORD", "NIC_USERNAME", "NIC_PASSWORD"]
    for var in env_vars:
        if os.environ.get(var):
            creds[var] = os.environ[var]
    if len(creds) < 4 and CREDENTIALS_FILE.exists():
        with open(CREDENTIALS_FILE) as f:
            for line in f:
                line = line.strip()
                if "=" in line and not line.startswith("#"):
                    key, value = line.split("=", 1)
                    creds[key.strip()] = value.strip()
    return creds

def save_token(access_token, expires_in):
    SECRETS_DIR.mkdir(parents=True, exist_ok=True)
    expires_at = datetime.now() + timedelta(seconds=expires_in)
    data = {"access_token": access_token, "expires_at": expires_at.isoformat()}
    with open(TOKEN_FILE, "w") as f:
        json.dump(data, f, indent=2)
    TOKEN_FILE.chmod(0o600)

def get_token(force_refresh=False):
    if not force_refresh and TOKEN_FILE.exists():
        try:
            with open(TOKEN_FILE) as f:
                data = json.load(f)
            if datetime.now() < datetime.fromisoformat(data["expires_at"]) - timedelta(minutes=5):
                return data["access_token"]
        except: pass
    
    creds = load_credentials()
    try:
        resp = requests.post(OAUTH_URL, data={
            "grant_type": "password",
            "username": creds["NIC_USERNAME"],
            "password": creds["NIC_PASSWORD"],
            "scope": "(GET|PUT|POST|DELETE):/dns-master/.+"
        }, auth=(creds["NIC_APP_LOGIN"], creds["NIC_APP_PASSWORD"]), timeout=30)
        resp.raise_for_status()
    except Exception as e:
        print(f"Auth failed: {e}", file=sys.stderr)
        sys.exit(1)
    
    data = resp.json()
    save_token(data["access_token"], data.get("expires_in", 3600))
    return data["access_token"]

def api_request(method, endpoint, data=None):
    token = get_token()
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/xml" if data else "application/x-www-form-urlencoded"
    }
    try:
        resp = requests.request(method, f"{API_BASE}{endpoint}", headers=headers, data=data, timeout=30)
        resp.raise_for_status()
        return ET.fromstring(resp.text)
    except Exception as e:
        print(f"API Error ({method} {endpoint}): {e}", file=sys.stderr)
        if hasattr(e, 'response') and e.response is not None:
            print(e.response.text, file=sys.stderr)
        sys.exit(1)

def find_service_for_zone(zone):
    for service in KNOWN_SERVICES:
        try:
            root = api_request("GET", f"/services/{service}/zones")
            for z in root.findall(".//zone"):
                if z.get("name") == zone or z.get("idn-name") == zone:
                    return service
        except: continue
    return None

def build_rr_xml(rtype, name, value, ttl):
    rtype = rtype.upper()
    name_xml = f"<name>{name}</name>" if name and name != "@" else "<name/>"
    
    data = ""
    if rtype == "A": data = f"<a>{value}</a>"
    elif rtype == "AAAA": data = f"<aaaa>{value}</aaaa>"
    elif rtype == "CNAME": data = f"<cname><name>{value}</name></cname>"
    elif rtype == "MX":
        parts = value.split(None, 1)
        data = f"<mx><preference>{parts[0]}</preference><exchange>{parts[1]}</exchange></mx>"
    elif rtype == "TXT": data = f"<txt><string>{value}</string></txt>"
    elif rtype == "NS": data = f"<ns>{value}</ns>"
    elif rtype == "SRV":
        p = value.split()
        data = f"<srv><priority>{p[0]}</priority><weight>{p[1]}</weight><port>{p[2]}</port><target>{p[3]}</target></srv>"
    
    return f"""<?xml version="1.0" encoding="UTF-8"?>
<request><rr-list><rr>
{name_xml}<ttl>{ttl}</ttl><type>{rtype}</type>{data}
</rr></rr-list></request>"""

def cmd_add(args):
    service = find_service_for_zone(args.zone)
    if not service:
        print(f"Zone {args.zone} not found.")
        sys.exit(1)
    
    xml = build_rr_xml(args.type, args.name, args.value, args.ttl)
    root = api_request("PUT", f"/services/{service}/zones/{args.zone}/records", data=xml)
    print(f"✓ Added {args.type} {args.name or '@'} -> {args.value}")

def cmd_delete(args):
    service = find_service_for_zone(args.zone)
    if not service:
        print(f"Zone {args.zone} not found.")
        sys.exit(1)
    
    api_request("DELETE", f"/services/{service}/zones/{args.zone}/records/{args.id}")
    print(f"✓ Deleted record {args.id}")

def cmd_commit(args):
    service = find_service_for_zone(args.zone)
    if not service:
        print("Zone not found.")
        return
    api_request("POST", f"/services/{service}/zones/{args.zone}/commit")
    print(f"✓ Committed {args.zone}")

def cmd_records(args):
    service = find_service_for_zone(args.zone)
    if not service:
        print("Zone not found.")
        return
    
    root = api_request("GET", f"/services/{service}/zones/{args.zone}/records")
    for rr in root.findall(".//rr"):
        rid = rr.get("id")
        rtype = rr.findtext("type")
        name = rr.findtext("name") or "@"
        
        val = ""
        if rtype == "A": val = rr.findtext("a")
        elif rtype == "CNAME": val = rr.findtext("cname/name")
        elif rtype == "MX": val = f"{rr.findtext('mx/preference')} {rr.findtext('mx/exchange')}"
        elif rtype == "TXT": val = " ".join([t.text for t in rr.findall("txt/string")])
        elif rtype == "NS": val = rr.findtext("ns")
        elif rtype == "SRV": val = f"{rr.findtext('srv/priority')} {rr.findtext('srv/weight')} {rr.findtext('srv/port')} {rr.findtext('srv/target')}"
        
        print(f"{rid:<10} {rtype:<6} {name:<20} {val}")

def main():
    parser = argparse.ArgumentParser()
    sub = parser.add_subparsers(dest="cmd", required=True)
    
    add = sub.add_parser("add")
    add.add_argument("zone")
    add.add_argument("type")
    add.add_argument("name")
    add.add_argument("value")
    add.add_argument("ttl", default=3600, nargs="?")
    add.set_defaults(func=cmd_add)
    
    delete = sub.add_parser("delete")
    delete.add_argument("zone")
    delete.add_argument("id")
    delete.set_defaults(func=cmd_delete)
    
    cmt = sub.add_parser("commit")
    cmt.add_argument("zone")
    cmt.set_defaults(func=cmd_commit)
    
    recs = sub.add_parser("records")
    recs.add_argument("zone")
    recs.set_defaults(func=cmd_records)
    
    auth = sub.add_parser("auth")
    auth.set_defaults(func=lambda x: get_token(True))
    
    zones = sub.add_parser("zones")
    zones.set_defaults(func=lambda x: print("Use 'nic-dns zones' original script for full list"))

    args = parser.parse_args()
    args.func(args)

if __name__ == "__main__":
    main()
